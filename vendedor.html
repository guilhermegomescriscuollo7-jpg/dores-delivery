<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel da Loja - Dores Delivery</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { background-color: #f4f5f7; display: flex; height: 100vh; color: #333; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; background: #fff; border-right: 1px solid #eee; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.02); z-index: 10; flex-shrink: 0; }
        .store-header { padding: 25px 20px; border-bottom: 1px solid #f2f2f2; text-align: center; }
        .store-logo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #ea1d2c; margin-bottom: 10px; }
        .store-name { font-size: 1.2rem; font-weight: 700; color: #111; }
        .store-status-toggle { margin-top: 10px; padding: 8px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; cursor: pointer; border: none; width: 100%; transition: 0.2s; }
        .status-open { background: #e6f4ea; color: #00a14b; }
        .status-closed { background: #fef0f0; color: #ea1d2c; }
        
        .nav-menu { list-style: none; flex: 1; margin-top: 15px; }
        .nav-item { padding: 18px 25px; cursor: pointer; color: #555; transition: 0.2s; font-weight: 500; display: flex; align-items: center; gap: 10px; border-left: 4px solid transparent; }
        .nav-item:hover, .nav-item.active { background: #fff5f5; color: #ea1d2c; border-left: 4px solid #ea1d2c; }
        .btn-logout { margin: 20px; padding: 12px; background: #f8f8f8; color: #777; text-align: center; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 25px; overflow-y: auto; background: #f4f5f7; height: 100vh; position: relative;}
        .section { display: none; height: 100%; }
        .section.active { display: block; }
        h2 { font-size: 1.5rem; color: #111; margin-bottom: 25px; }

        /* TOAST NOTIFICATION */
        .toast-notification {
            position: absolute; top: 30px; right: -400px; width: 320px;
            background: #fff; border-left: 6px solid #00a14b; border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); padding: 20px;
            display: flex; align-items: center; gap: 15px; z-index: 9999;
            transition: right 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .toast-notification.show { right: 30px; }

        /* KANBAN PEDIDOS */
        .kanban-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; height: calc(100% - 60px); }
        .kanban-col { background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow-y: auto; }
        .order-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .payment-box { padding: 8px; border-radius: 6px; font-size: 0.85rem; font-weight: bold; margin-bottom: 10px; }
        .pay-pix { background: #fdf5e6; color: #997404; border: 1px solid #f9e1b5; }
        .order-total { font-size: 1.2rem; font-weight: 900; text-align: right; margin-bottom: 10px; }
        .btn-action { width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: #fff; }

        /* CARD√ÅPIO MASTER-DETAIL */
        .menu-layout { display: flex; gap: 20px; height: calc(100% - 60px); }
        .menu-list-area { flex: 1; background: #fff; border-radius: 8px; border: 1px solid #e0e0e0; display: flex; flex-direction: column; overflow: hidden; }
        .menu-edit-area { width: 450px; background: #fff; border-radius: 8px; border: 1px solid #e0e0e0; display: flex; flex-direction: column; }
        .editor-scroll { flex: 1; overflow-y: auto; padding: 20px; }
        .product-row { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .product-row.selected { background: #eef4ff; border-left: 4px solid #0d6efd; }
        .row-img { width: 45px; height: 45px; border-radius: 6px; object-fit: cover; margin-right: 15px; }

        /* RELAT√ìRIOS */
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .report-card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e0e0e0; }
        .rep-value { font-size: 1.8rem; font-weight: 900; }
        .rep-value.green { color: #00a14b; }
        .top-products-list li { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eee; display: flex; justify-content: space-between; margin-bottom: 10px; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="store-header">
            <img src="" id="ui-store-logo" class="store-logo" alt="Logo">
            <div class="store-name" id="ui-store-name">Carregando...</div>
            <button id="btn-toggle-status" class="store-status-toggle" onclick="toggleStoreStatus()">Verificando...</button>
        </div>
        <ul class="nav-menu">
            <li class="nav-item active" onclick="switchTab('pedidos', this)">üìã Gest√£o de Pedidos</li>
            <li class="nav-item" onclick="switchTab('cardapio', this)">üçî Meu Card√°pio</li>
            <li class="nav-item" onclick="switchTab('relatorios', this)">üìä Relat√≥rios</li>
        </ul>
        <div class="btn-logout" onclick="logout()">Sair</div>
    </aside>

    <main class="main-content">
        <div id="new-order-toast" class="toast-notification">
            <div>üîî</div>
            <div><h4>Novo Pedido!</h4><p>Confira na aba de pendentes.</p></div>
        </div>

        <section id="pedidos" class="section active">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>Pedidos em Tempo Real</h2>
                <button onclick="unlockAudio()" style="background:#ea1d2c; color:#fff; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold;">Ativar Som e Alertas</button>
            </div>
            <div class="kanban-board">
                <div class="kanban-col"><div id="list-pendente"></div></div>
                <div class="kanban-col"><div id="list-preparo"></div></div>
                <div class="kanban-col"><div id="list-concluido"></div></div>
            </div>
        </section>

        <section id="relatorios" class="section">
            <h2>Relat√≥rios de Vendas</h2>
            <div class="report-grid">
                <div class="report-card"><div>Hoje</div><div class="rep-value green" id="rep-hoje">R$ 0,00</div></div>
                <div class="report-card"><div>Semana</div><div class="rep-value green" id="rep-semana">R$ 0,00</div></div>
                <div class="report-card"><div>M√™s</div><div class="rep-value green" id="rep-mes">R$ 0,00</div></div>
                <div class="report-card"><div>Total</div><div class="rep-value" id="rep-total">R$ 0,00</div></div>
            </div>
            <h3>Top 3 Produtos</h3>
            <ul id="rep-top-products" class="top-products-list"></ul>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBinV28T4xWvYAnE0Yed1rbsp9dEF_n7Eg",
            authDomain: "dores-delivery.firebaseapp.com",
            projectId: "dores-delivery",
            storageBucket: "dores-delivery.firebasestorage.app",
            messagingSenderId: "1029498697239",
            appId: "1:1029498697239:web:3ebc070bbd65048bd9ce52"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const loggedStore = JSON.parse(localStorage.getItem('loggedStore'));

        if (!loggedStore) window.location.href = 'login-vendedor.html';

        document.getElementById('ui-store-name').innerText = loggedStore.name;
        document.getElementById('ui-store-logo').src = loggedStore.logo;

        // --- SISTEMA DE √ÅUDIO LONGO ---
        let audioUnlocked = false;
        function unlockAudio() { 
            audioUnlocked = true; 
            alert("Som ativado! Agora voc√™ ouvir√° o toque longo para novos pedidos.");
        }
        window.unlockAudio = unlockAudio;

        function playLongAlert() {
            if (!audioUnlocked) return;
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            for (let i = 0; i < 5; i++) {
                let start = ctx.currentTime + (i * 1.5);
                const osc = ctx.createOscillator();
                const g = ctx.createGain();
                osc.connect(g); g.connect(ctx.destination);
                osc.frequency.setValueAtTime(880, start);
                g.gain.setValueAtTime(0.5, start);
                g.gain.exponentialRampToValueAtTime(0.01, start + 1);
                osc.start(start); osc.stop(start + 1);
            }
        }

        // --- GEST√ÉO DE PEDIDOS EM TEMPO REAL ---
        let firstLoad = true;
        const q = query(collection(db, "orders"), where("storeId", "==", loggedStore.id));

        onSnapshot(q, (snapshot) => {
            const orders = [];
            snapshot.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));
            
            if (!firstLoad && snapshot.docChanges().some(change => change.type === "added")) {
                playLongAlert();
                document.getElementById('new-order-toast').classList.add('show');
                setTimeout(() => document.getElementById('new-order-toast').classList.remove('show'), 8000);
            }
            firstLoad = false;
            renderOrders(orders);
            calculateReports(orders);
        });

        function renderOrders(orders) {
            const cols = { 'Pendente': 'list-pendente', 'Preparo': 'list-preparo', 'Concluido': 'list-concluido' };
            Object.values(cols).forEach(id => document.getElementById(id).innerHTML = '');

            orders.forEach(order => {
                const card = `
                    <div class="order-card">
                        <strong>#${order.id.slice(0,5)}</strong> - ${order.customerName}
                        <div class="order-total">R$ ${order.total.toFixed(2)}</div>
                        <button class="btn-action" style="background:#00a14b" onclick="updateStatus('${order.id}', 'Preparo')">Aceitar</button>
                    </div>`;
                const colId = cols[order.status] || 'list-pendente';
                document.getElementById(colId).innerHTML += card;
            });
        }

        window.updateStatus = async (id, status) => {
            await updateDoc(doc(db, "orders", id), { status });
        };

        // --- RELAT√ìRIOS ---
        function calculateReports(orders) {
            let total = 0, hoje = 0;
            const now = new Date().toLocaleDateString();
            const products = {};

            orders.forEach(o => {
                total += o.total;
                if (o.date === now) hoje += o.total;
                o.items.forEach(i => {
                    products[i.name] = (products[i.name] || 0) + i.qty;
                });
            });

            document.getElementById('rep-total').innerText = `R$ ${total.toFixed(2)}`;
            document.getElementById('rep-hoje').innerText = `R$ ${hoje.toFixed(2)}`;

            const top3 = Object.entries(products).sort((a,b) => b[1] - a[1]).slice(0,3);
            document.getElementById('rep-top-products').innerHTML = top3.map(([name, qty]) => `<li>${name} <span>${qty} vendidos</span></li>`).join('');
        }

        window.switchTab = (id, el) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        };
    </script>
</body>
</html>
