<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Entregador - Dores Delivery</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { background-color: #f4f5f7; color: #333; padding-bottom: 30px; }

        /* HEADER */
        header { background: #111; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        header h1 { font-size: 1.2rem; font-weight: 700; color: #ea1d2c; display: flex; align-items: center; gap: 8px; margin: 0; }
        .btn-sound { background: #333; color: #fff; border: 1px solid #555; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: bold; transition: 0.2s;}
        .btn-sound:active { transform: scale(0.95); }

        .container { padding: 15px; max-width: 600px; margin: 0 auto; }

        /* QUADRO DE GANHOS */
        .dashboard-header { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        .welcome-text { font-size: 0.95rem; color: #555; font-weight: 500; }
        .welcome-text strong { color: #111; font-size: 1.1rem; display: block; margin-top: 3px; }
        .earnings-card { text-align: right; }
        .earnings-label { font-size: 0.75rem; color: #777; text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; }
        .earnings-value { font-size: 1.6rem; color: #00a14b; font-weight: 900; margin-top: 2px; }

        /* ESTADO VAZIO */
        .empty-state { text-align: center; padding: 60px 20px; display: none; }
        .empty-state span { font-size: 3rem; display: block; margin-bottom: 15px; }
        .empty-state h3 { color: #111; margin-bottom: 10px; font-size: 1.2rem; }
        .empty-state p { color: #717171; font-size: 0.95rem; line-height: 1.4; }

        /* CART√ÉO DE ENTREGA */
        .delivery-card { background: #fff; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 2px solid #fd7e14; overflow: hidden; animation: slideIn 0.3s ease; position: relative; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .card-header { background: #fff1e6; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #fcd5b4; color: #d9534f; font-weight: 900; }
        .order-id { font-size: 1.1rem; }

        .card-body { padding: 15px; }
        
        .fee-badge { position: absolute; top: 10px; right: 15px; background: #00a14b; color: #fff; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,161,75,0.3); }

        .info-row { margin-bottom: 15px; display: flex; gap: 10px; align-items: flex-start; }
        .info-icon { font-size: 1.2rem; margin-top: 2px; }
        .info-text { width: 100%; }
        .info-text strong { display: block; color: #111; font-size: 1rem; margin-bottom: 3px; }
        .info-text p { color: #555; font-size: 0.9rem; line-height: 1.4; margin-bottom: 0; }

        /* BOT√ÉO DE GPS COMPACTO */
        .btn-gps { 
            display: inline-flex; 
            align-items: center; 
            gap: 6px; 
            background: #111; 
            color: #fff; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 6px; 
            font-size: 0.85rem; 
            font-weight: 700; 
            text-decoration: none; 
            margin-top: 8px; 
            transition: 0.2s; 
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2); 
            text-transform: uppercase; 
        }
        .btn-gps:active { 
            transform: scale(0.95); 
            background: #000; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3); 
        }

        /* Estilos espec√≠ficos para a caixa de endere√ßo da loja */
        .store-address-box { background: #fafafa; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-top: 5px; }
        .store-address-box p { margin: 2px 0; color: #444; font-size: 0.85rem; }
        .store-doc { font-size: 0.75rem; color: #999; margin-top: 5px; display: block; }

        .items-box { background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px dashed #ccc; margin-bottom: 15px; font-size: 0.85rem; color: #555; }
        .items-box ul { list-style: none; padding-left: 0; }
        .items-box li { margin-bottom: 4px; }

        .payment-box { background: #e6f4ea; border: 1px solid #badbcc; color: #0f5132; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; margin-bottom: 15px; }
        .payment-box .total { font-size: 1.2rem; font-weight: 900; }

        .btn-deliver { width: 100%; color: #fff; border: none; padding: 18px; border-radius: 8px; font-weight: 900; font-size: 1.1rem; cursor: pointer; transition: background 0.2s; text-transform: uppercase; }
        .btn-deliver:active { transform: scale(0.98); }

        /* ABA DE CONCLU√çDOS (Hist√≥rico do dia) */
        .history-title { font-size: 1rem; color: #777; margin: 30px 0 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center;}
        .history-card { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; opacity: 0.8; }
        .history-fee { font-size: 1rem; color: #00a14b; font-weight: bold; background: #e6f4ea; padding: 4px 8px; border-radius: 6px; }
    </style>
</head>
<body>

    <header>
        <h1>
            <svg viewBox="0 0 100 50" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: auto; transform: rotate(-10deg);">
                <path d="M5 15 Q 50 55 95 15" stroke="#ea1d2c" stroke-width="8" stroke-linecap="round"/>
            </svg>
            Entregas
        </h1>
        <div style="display: flex; gap: 10px;">
            <button class="btn-sound" onclick="window.unlockAudio()">üîä Som</button>
            <button class="btn-sound" style="background: #ea1d2c; border-color: #c81824;" onclick="window.logoutDriver()">Sair</button>
        </div>
    </header>

    <main class="container">
        
        <div class="dashboard-header">
            <div class="welcome-text">
                Ol√°,
                <strong id="driver-name-display">Entregador</strong>
            </div>
            <div class="earnings-card">
                <div class="earnings-label">Ganhos Hoje</div>
                <div class="earnings-value" id="today-earnings">R$ 0,00</div>
            </div>
        </div>

        <div id="empty-state" class="empty-state">
            <span>‚òï</span>
            <h3>Nenhuma entrega pendente</h3>
            <p>Aguarde. Quando uma loja solicitar um entregador, o pedido aparecer√° aqui automaticamente.</p>
        </div>

        <div id="active-deliveries">
            </div>

        <h3 class="history-title" id="history-title" style="display:none;">
            ‚úÖ Entregas Conclu√≠das Hoje
            <span id="history-count" style="background:#ea1d2c; color:#fff; padding:2px 8px; border-radius:12px; font-size:0.8rem;">0</span>
        </h3>
        <div id="history-deliveries">
            </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ==========================================
        // 1. TRAVA DE SEGURAN√áA (VERIFICA LOGIN)
        // ==========================================
        const loggedDriverStr = localStorage.getItem('loggedDriver');
        
        if (!loggedDriverStr) {
            window.location.href = "login-entregador.html";
        }
        
        const loggedDriver = JSON.parse(loggedDriverStr);
        document.getElementById('driver-name-display').innerText = loggedDriver.name;

        window.logoutDriver = () => {
            if (confirm("Tem certeza que deseja encerrar seu turno e sair?")) {
                localStorage.removeItem('loggedDriver');
                window.location.href = "login-entregador.html";
            }
        };

        // ==========================================
        // 2. CONFIGURA√á√ÉO OFICIAL DO FIREBASE
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBinV28T4xWvYAnE0Yed1rbsp9dEF_n7Eg",
            authDomain: "dores-delivery.firebaseapp.com",
            projectId: "dores-delivery",
            storageBucket: "dores-delivery.firebasestorage.app",
            messagingSenderId: "1029498697239",
            appId: "1:1029498697239:web:3ebc070bbd65048bd9ce52"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ==========================================
        // 3. SISTEMA DE ALERTA SONORO
        // ==========================================
        let audioUnlocked = false;
        let previousDeliveryCount = -1;

        window.unlockAudio = () => {
            audioUnlocked = true;
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                ctx.resume().then(() => alert("Som ativado! Deixe a tela aberta para ouvir os alertas."));
            } catch(e) {}
        };

        function playDeliveryAlert() {
            if (!audioUnlocked) return;
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'triangle'; 
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(1200, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.5, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.5);
            } catch (e) { console.log("Som bloqueado."); }
        }

        // ==========================================
        // 4. DADOS DE LOJAS E PEDIDOS (TEMPO REAL)
        // ==========================================
        let globalStores = [];
        let currentActiveDeliveries = [];
        let currentHistoryDeliveries = [];

        onSnapshot(collection(db, "stores"), (snapshot) => {
            globalStores = [];
            snapshot.forEach(doc => globalStores.push({ id: doc.id, ...doc.data() }));
            renderDeliveries(currentActiveDeliveries, currentHistoryDeliveries);
        });

        const qOrders = query(collection(db, "orders"));
        onSnapshot(qOrders, (snapshot) => {
            const allOrders = [];
            snapshot.forEach(document => allOrders.push({ id: document.id, ...document.data() }));

            // Filtra entregas ativas para este entregador
            currentActiveDeliveries = allOrders.filter(o => {
                if (o.status === "Aguardando Entregador") return true;
                if (o.status === "Saiu para Entrega" && o.driverName === loggedDriver.name) return true;
                return false;
            });
            
            // Toca alarme se chegou corrida nova
            const pendingDeliveriesCount = currentActiveDeliveries.filter(o => o.status === "Aguardando Entregador").length;
            if (previousDeliveryCount !== -1 && pendingDeliveriesCount > previousDeliveryCount) {
                playDeliveryAlert();
            }
            previousDeliveryCount = pendingDeliveriesCount;

            // MATEM√ÅTICA DE DATA PARA O HIST√ìRICO
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();

            currentHistoryDeliveries = allOrders.filter(o => {
                const isCompletedStatus = (o.status === "Conclu√≠do" || o.status === "Concluido" || o.status === "Entregue");
                const isMyDelivery = (o.driverName === loggedDriver.name);
                const isFromToday = (o.timestamp >= startOfToday);

                return isCompletedStatus && isMyDelivery && isFromToday;
            });

            renderDeliveries(currentActiveDeliveries, currentHistoryDeliveries);
        });

        // ==========================================
        // 5. RENDERIZAR TELA COM GANHOS E INFORMA√á√ïES
        // ==========================================
        function renderDeliveries(active, history) {
            
            // ATUALIZA O VALOR DOS GANHOS DI√ÅRIOS
            const todayEarnings = history.reduce((acc, order) => {
                const fee = (order.platformDriverFee !== undefined && order.platformDriverFee !== null) ? parseFloat(order.platformDriverFee) : 5.00;
                return acc + fee;
            }, 0);
            document.getElementById('today-earnings').innerText = `R$ ${todayEarnings.toFixed(2).replace('.', ',')}`;

            const containerActive = document.getElementById('active-deliveries');
            const emptyState = document.getElementById('empty-state');
            
            if (active.length === 0) {
                emptyState.style.display = 'block';
                containerActive.innerHTML = '';
            } else {
                emptyState.style.display = 'none';
                
                containerActive.innerHTML = active.sort((a,b) => a.timestamp - b.timestamp).map(order => {
                    const shortId = order.id.substring(0, 6).toUpperCase();
                    const itemsHtml = order.items.map(i => `<li><b>${i.qty}x</b> ${i.name}</li>`).join('');
                    
                    // Taxa de entrega desta corrida
                    const driverFee = (order.platformDriverFee !== undefined && order.platformDriverFee !== null) ? parseFloat(order.platformDriverFee).toFixed(2) : "5.00";

                    // BUSCA INFORMA√á√ÉO COMPLETA DA LOJA
                    const storeInfo = globalStores.find(s => s.id === order.storeId);
                    let storeDetailsHtml = '';
                    
                    if(storeInfo) {
                        const street = storeInfo.street || 'Endere√ßo n√£o informado';
                        const cityInfo = storeInfo.city ? `${storeInfo.city}${storeInfo.state ? ' - ' + storeInfo.state : ''}` : '';
                        const cep = storeInfo.cep ? `CEP: ${storeInfo.cep}` : '';
                        const doc = storeInfo.doc ? `CNPJ/CPF: ${storeInfo.doc}` : '';
                        
                        // EXIBE A CIDADE ANTES DA RUA DA LOJA
                        storeDetailsHtml = `
                            <div class="store-address-box">
                                <p>üìç <strong>${cityInfo ? cityInfo + ' ‚ûî ' : ''}${street}</strong></p>
                                <span class="store-doc">${cep} ${cep && doc ? '|' : ''} ${doc}</span>
                            </div>
                        `;
                    } else {
                        storeDetailsHtml = `<div class="store-address-box"><p>Aguardando dados de endere√ßo...</p></div>`;
                    }

                    // NOME DA CIDADE E BOT√ÉO DE GPS PARA O CLIENTE
                    const customerCity = "Dores√≥polis"; 
                    
                    // Remove qualquer complemento entre par√™nteses para exibir e pesquisar no GPS limpo
                    const cleanAddress = order.customer.address.replace(/\s*\([^)]*\)/g, '').trim();
                    const displayCustomerAddress = `${customerCity} ‚ûî ${cleanAddress}`;
                    
                    // üü¢ LINK OFICIAL DO GOOGLE MAPS PARA ROTAS (DIRECTIONS API) üü¢
                    const addressForGPS = encodeURIComponent(`${customerCity}, MG, ${cleanAddress}`);
                    const linkGPS = `https://www.google.com/maps/dir/?api=1&destination=${addressForGPS}`;
                    const btnGPSHtml = `<a href="${linkGPS}" target="_blank" class="btn-gps">üó∫Ô∏è GPS</a>`;
                    
                    let btnHtml = '';
                    if (order.status === 'Aguardando Entregador') {
                        btnHtml = `<button class="btn-deliver" style="background:#0d6efd;" onclick="window.acceptDelivery('${order.id}')">üì≤ ACEITAR CORRIDA</button>`;
                    } else {
                        btnHtml = `<button class="btn-deliver" style="background:#00a14b;" onclick="window.confirmDelivery('${order.id}', '${order.customerName}')">‚úÖ CONFIRMAR ENTREGA</button>`;
                    }

                    return `
                    <div class="delivery-card">
                        <div class="fee-badge">üí∞ + R$ ${driverFee.replace('.', ',')}</div>
                        
                        <div class="card-header">
                            <span class="order-id">Pedido #${shortId}</span>
                            <span>${order.date ? order.date.split(' ')[1] : ''}</span>
                        </div>
                        <div class="card-body">
                            
                            <div class="info-row">
                                <div class="info-icon">üè™</div>
                                <div class="info-text" style="width: 100%;">
                                    <strong style="color: #ea1d2c;">Retirar em: ${order.storeName}</strong>
                                    ${storeDetailsHtml}
                                </div>
                            </div>

                            <div class="info-row">
                                <div class="info-icon">üìç</div>
                                <div class="info-text">
                                    <strong style="color: #0d6efd;">Entregar para: ${order.customerName}</strong>
                                    <p style="font-size: 0.95rem; font-weight: 500; color: #333;">${displayCustomerAddress}</p>
                                    ${btnGPSHtml}
                                </div>
                            </div>

                            <div class="items-box">
                                <strong>Itens do pedido:</strong>
                                <ul>${itemsHtml}</ul>
                            </div>

                            <div class="payment-box">
                                <div>
                                    <div style="font-size:0.75rem; color:#555;">Cobrar do Cliente:</div>
                                    <div>${order.paymentMethod}</div>
                                </div>
                                <div class="total">
                                    R$ ${order.total.toFixed(2)}
                                </div>
                            </div>

                            ${btnHtml}
                        </div>
                    </div>`;
                }).join('');
            }

            // RENDERIZA HIST√ìRICO
            const containerHistory = document.getElementById('history-deliveries');
            const titleHistory = document.getElementById('history-title');
            const countHistory = document.getElementById('history-count');
            
            if (history.length > 0) {
                titleHistory.style.display = 'flex';
                countHistory.innerText = history.length;
                containerHistory.innerHTML = history.sort((a,b) => b.timestamp - a.timestamp).map(order => {
                    const shortId = order.id.substring(0, 6).toUpperCase();
                    const driverFee = (order.platformDriverFee !== undefined && order.platformDriverFee !== null) ? parseFloat(order.platformDriverFee).toFixed(2) : "5.00";
                    
                    return `
                    <div class="history-card">
                        <div>
                            <strong>#${shortId}</strong> - ${order.customerName}<br>
                            <span style="font-size:0.8rem; color:#777;">${order.storeName}</span>
                        </div>
                        <div class="history-fee">+ R$ ${driverFee.replace('.', ',')}</div>
                    </div>`;
                }).join('');
            } else {
                titleHistory.style.display = 'none';
                containerHistory.innerHTML = '';
            }
        }

        // ==========================================
        // 6. A√á√ïES DO ENTREGADOR
        // ==========================================
        window.acceptDelivery = async (orderId) => {
            if(confirm('Deseja assumir esta entrega?')) {
                try {
                    await updateDoc(doc(db, "orders", orderId), { 
                        status: "Saiu para Entrega",
                        driverName: loggedDriver.name
                    });
                } catch(error) {
                    console.error("Erro ao aceitar:", error);
                    alert("Erro de conex√£o. Tente novamente.");
                }
            }
        };

        window.confirmDelivery = async (orderId, customerName) => {
            if(confirm(`Tem certeza que j√° entregou o pedido ao cliente ${customerName}?`)) {
                try {
                    // MUDA PARA "ENTREGUE" PARA ESPERAR O CLIENTE CONFIRMAR
                    await updateDoc(doc(db, "orders", orderId), { 
                        status: "Entregue" 
                    });
                } catch(error) {
                    console.error("Erro ao atualizar:", error);
                    alert("Ocorreu um erro de conex√£o. Tente novamente.");
                }
            }
        };

    </script>
</body>
</html>
