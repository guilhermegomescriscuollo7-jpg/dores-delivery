<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - Dores Delivery</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { background-color: #f8f8f8; color: #3e3e3e; padding-bottom: 90px; }

        /* HEADER */
        header { background: #fff; padding: 20px; text-align: center; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        header h1 { font-size: 1.2rem; font-weight: 700; color: #111; }

        .container { padding: 15px; }

        /* ESTADO N√ÉO LOGADO */
        .empty-state { text-align: center; padding: 60px 20px; display: none; }
        .empty-state span { font-size: 3rem; display: block; margin-bottom: 15px; }
        .empty-state h3 { color: #111; margin-bottom: 10px; font-size: 1.2rem; }
        .empty-state p { color: #717171; margin-bottom: 20px; font-size: 0.95rem; line-height: 1.4; }
        .btn-primary { background: #ea1d2c; color: #fff; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; text-decoration: none; display: inline-block; transition: 0.2s; cursor: pointer; width: 100%; font-size: 1rem; }
        .btn-primary:hover { background: #c81824; }

        /* HEADER DO PERFIL (LOGADO) */
        .profile-header-card { background: #fff; border-radius: 12px; padding: 25px 20px; display: flex; align-items: center; gap: 20px; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); border: 1px solid #f2f2f2; }
        .avatar { width: 70px; height: 70px; background-color: #ea1d2c; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; flex-shrink: 0; }
        .profile-info { flex: 1; overflow: hidden; }
        .profile-info h2 { font-size: 1.3rem; color: #111; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .profile-info p { font-size: 0.9rem; color: #717171; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* LISTA DE OP√á√ïES (MENU) */
        .menu-list { background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); border: 1px solid #f2f2f2; overflow: hidden; margin-bottom: 20px; }
        .menu-item { display: flex; align-items: center; justify-content: space-between; padding: 18px 20px; border-bottom: 1px solid #f8f8f8; cursor: pointer; transition: background 0.2s; text-decoration: none; color: #333; }
        .menu-item:active { background-color: #f9f9f9; }
        .menu-item:last-child { border-bottom: none; }
        .menu-item-left { display: flex; align-items: center; gap: 15px; font-size: 1rem; font-weight: 500; }
        .menu-icon { font-size: 1.3rem; }
        .menu-arrow { color: #ccc; font-size: 1.2rem; font-weight: bold; }

        /* BOT√ÉO DE SAIR */
        .logout-btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; background: #fff; border: 1px solid #fbd5d5; color: #ea1d2c; padding: 16px; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
        .logout-btn:active { background: #fef0f0; }

        /* MENU INFERIOR GERAL */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #eee; z-index: 150; }
        .nav-link { text-align: center; color: #717171; font-size: 0.7rem; text-decoration: none; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: 0.2s; }
        .nav-icon-img { width: 24px; height: 24px; filter: invert(20%) sepia(91%) saturate(5437%) hue-rotate(352deg) brightness(94%) contrast(98%); }
        .nav-link.active { color: #ea1d2c; font-weight: bold; }

        /* =========================================================
           MODAIS DE EDI√á√ÉO (ENDERE√áO E CONFIGURA√á√ïES)
           ========================================================= */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: flex-end; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #fff; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 25px 20px; animation: slideUp 0.3s ease forwards; max-height: 90vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #f2f2f2; padding-bottom: 15px; }
        .modal-header h3 { font-size: 1.2rem; color: #111; }
        .close-modal { background: none; border: none; font-size: 1.5rem; color: #999; cursor: pointer; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.85rem; color: #777; margin-bottom: 5px; font-weight: 500; }
        .form-group input { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; outline: none; background: #f9f9f9; transition: 0.2s; }
        .form-group input:focus { border-color: #ea1d2c; background: #fff; }
        .row-inputs { display: flex; gap: 10px; }
        .row-inputs .form-group { flex: 1; }
    </style>
</head>
<body>

    <header>
        <h1>Meu Perfil</h1>
    </header>

    <main class="container">

        <div id="unlogged-state" class="empty-state">
            <span>üë§</span>
            <h3>Bem-vindo ao Dores Delivery</h3>
            <p>Fa√ßa login ou crie uma conta para gerenciar seus dados, endere√ßos e ver seu hist√≥rico.</p>
            <a href="login.html" class="btn-primary">Entrar ou Cadastrar</a>
        </div>

        <div id="logged-state" style="display: none;">
            
            <div class="profile-header-card">
                <div class="avatar" id="user-avatar">?</div>
                <div class="profile-info">
                    <h2 id="display-name">Carregando...</h2>
                    <p id="display-email">carregando@email.com</p>
                    <p id="display-phone">(00) 00000-0000</p>
                </div>
            </div>

            <div class="menu-list">
                <a class="menu-item" onclick="window.openAddressModal()">
                    <div class="menu-item-left">
                        <span class="menu-icon">üìç</span> Endere√ßo de Entrega
                    </div>
                    <span class="menu-arrow">‚Ä∫</span>
                </a>
                
                <a href="pedidos.html" class="menu-item">
                    <div class="menu-item-left">
                        <span class="menu-icon">üßæ</span> Meus Pedidos
                    </div>
                    <span class="menu-arrow">‚Ä∫</span>
                </a>
            </div>

            <div class="menu-list">
                <a class="menu-item" onclick="window.openSettingsModal()">
                    <div class="menu-item-left">
                        <span class="menu-icon">‚öôÔ∏è</span> Configura√ß√µes da Conta
                    </div>
                    <span class="menu-arrow">‚Ä∫</span>
                </a>
            </div>

            <button class="logout-btn" onclick="window.logoutCustomer()">
                Sair da conta
            </button>
        </div>

    </main>

    <div class="modal-overlay" id="address-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìç Meu Endere√ßo</h3>
                <button class="close-modal" onclick="window.closeModals()">‚úï</button>
            </div>
            <p style="font-size: 0.85rem; color: #777; margin-bottom: 15px;">Este endere√ßo ser√° preenchido automaticamente no seu carrinho de compras (Futuro update).</p>
            
            <div class="form-group">
                <label>Rua / Avenida</label>
                <input type="text" id="mod-rua" placeholder="Ex: Rua Direita">
            </div>
            <div class="row-inputs">
                <div class="form-group" style="flex: 0.4;">
                    <label>N√∫mero</label>
                    <input type="text" id="mod-num" placeholder="Ex: 123">
                </div>
                <div class="form-group" style="flex: 0.6;">
                    <label>Bairro</label>
                    <input type="text" id="mod-bairro" placeholder="Ex: Centro">
                </div>
            </div>
            <div class="form-group">
                <label>Complemento (Opcional)</label>
                <input type="text" id="mod-comp" placeholder="Apto, Bloco, Casa fundos...">
            </div>
            <button class="btn-primary" onclick="window.saveAddress()" style="margin-top: 10px;">Salvar Endere√ßo</button>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è Dados da Conta</h3>
                <button class="close-modal" onclick="window.closeModals()">‚úï</button>
            </div>
            
            <div class="form-group">
                <label>Nome Completo</label>
                <input type="text" id="mod-name">
            </div>
            <div class="form-group">
                <label>Celular / WhatsApp</label>
                <input type="tel" id="mod-phone">
            </div>
            <div class="form-group">
                <label>E-mail de Login</label>
                <input type="email" id="mod-email">
            </div>
            <div class="form-group">
                <label>Senha de Acesso</label>
                <input type="text" id="mod-pass" placeholder="Digite uma nova senha">
            </div>
            <button class="btn-primary" onclick="window.saveSettings()" style="margin-top: 10px;">Salvar Altera√ß√µes</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-link">
            <img src="https://cdn-icons-png.flaticon.com/512/25/25694.png" class="nav-icon-img" alt="In√≠cio">
            <span>In√≠cio</span>
        </a>
        <a href="pedidos.html" class="nav-link">
            <img src="https://cdn-icons-png.flaticon.com/512/1150/1150592.png" class="nav-icon-img" alt="Pedidos">
            <span>Pedidos</span>
        </a>
        <a href="perfil.html" class="nav-link active">
            <img src="https://cdn-icons-png.flaticon.com/512/1077/1077063.png" class="nav-icon-img" alt="Perfil">
            <span>Perfil</span>
        </a>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // SUA CONFIGURA√á√ÉO OFICIAL FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBinV28T4xWvYAnE0Yed1rbsp9dEF_n7Eg",
            authDomain: "dores-delivery.firebaseapp.com",
            projectId: "dores-delivery",
            storageBucket: "dores-delivery.firebasestorage.app",
            messagingSenderId: "1029498697239",
            appId: "1:1029498697239:web:3ebc070bbd65048bd9ce52"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Verifica estado do usu√°rio
        const loggedCustomer = JSON.parse(localStorage.getItem('loggedCustomer'));
        const isLogged = !!loggedCustomer || localStorage.getItem('isLogged') === 'true';
        let userEmail = loggedCustomer ? loggedCustomer.email : localStorage.getItem('userEmail');

        let currentUserDocId = null;
        let currentUserData = null;

        async function loadProfile() {
            const unloggedState = document.getElementById('unlogged-state');
            const loggedState = document.getElementById('logged-state');

            if (!isLogged || !userEmail) {
                unloggedState.style.display = 'block';
                loggedState.style.display = 'none';
            } else {
                unloggedState.style.display = 'none';
                loggedState.style.display = 'block';

                try {
                    // Busca os dados do cliente no Firebase pelo email
                    const q = query(collection(db, "customers"), where("email", "==", userEmail));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        querySnapshot.forEach((document) => {
                            currentUserDocId = document.id;
                            currentUserData = document.data();
                        });

                        document.getElementById('display-name').innerText = currentUserData.name;
                        document.getElementById('display-email').innerText = currentUserData.email;
                        document.getElementById('display-phone').innerText = currentUserData.phone || 'Sem telefone';
                        document.getElementById('user-avatar').innerText = currentUserData.name.charAt(0).toUpperCase();
                    } else {
                        document.getElementById('display-name').innerText = 'Usu√°rio n√£o encontrado';
                    }
                } catch (error) {
                    console.error("Erro ao carregar perfil:", error);
                }
            }
        }

        // =====================================
        // CONTROLO DE MODAIS
        // =====================================
        window.closeModals = () => {
            document.getElementById('address-modal').classList.remove('active');
            document.getElementById('settings-modal').classList.remove('active');
        };

        window.openAddressModal = () => {
            if(currentUserData && currentUserData.address) {
                document.getElementById('mod-rua').value = currentUserData.address.rua || '';
                document.getElementById('mod-num').value = currentUserData.address.num || '';
                document.getElementById('mod-bairro').value = currentUserData.address.bairro || '';
                document.getElementById('mod-comp').value = currentUserData.address.comp || '';
            } else {
                document.getElementById('mod-rua').value = '';
                document.getElementById('mod-num').value = '';
                document.getElementById('mod-bairro').value = '';
                document.getElementById('mod-comp').value = '';
            }
            document.getElementById('address-modal').classList.add('active');
        };

        window.saveAddress = async () => {
            const rua = document.getElementById('mod-rua').value.trim();
            const num = document.getElementById('mod-num').value.trim();
            const bairro = document.getElementById('mod-bairro').value.trim();
            const comp = document.getElementById('mod-comp').value.trim();

            if(!rua || !num || !bairro) {
                alert("Por favor, preencha a Rua, N√∫mero e Bairro.");
                return;
            }

            try {
                // Atualiza no banco de dados Firebase
                await updateDoc(doc(db, "customers", currentUserDocId), {
                    address: { rua, num, bairro, comp }
                });
                
                currentUserData.address = { rua, num, bairro, comp }; // Atualiza local
                alert("Endere√ßo salvo com sucesso!");
                window.closeModals();
            } catch (error) {
                console.error(error);
                alert("Erro ao salvar endere√ßo.");
            }
        };

        window.openSettingsModal = () => {
            if(currentUserData) {
                document.getElementById('mod-name').value = currentUserData.name || '';
                document.getElementById('mod-phone').value = currentUserData.phone || '';
                document.getElementById('mod-email').value = currentUserData.email || '';
                document.getElementById('mod-pass').value = currentUserData.password || '';
            }
            document.getElementById('settings-modal').classList.add('active');
        };

        window.saveSettings = async () => {
            const name = document.getElementById('mod-name').value.trim();
            const phone = document.getElementById('mod-phone').value.trim();
            const newEmail = document.getElementById('mod-email').value.trim();
            const pass = document.getElementById('mod-pass').value.trim();

            if(!name || !newEmail || !pass) {
                alert("Nome, E-mail e Senha s√£o obrigat√≥rios.");
                return;
            }

            try {
                // Se ele tentou trocar o email, verifica se o novo j√° existe
                if (newEmail !== userEmail) {
                    const q = query(collection(db, "customers"), where("email", "==", newEmail));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        alert("Este e-mail j√° est√° sendo usado por outra conta.");
                        return;
                    }
                }

                // Salva altera√ß√µes no Firebase
                await updateDoc(doc(db, "customers", currentUserDocId), {
                    name: name, phone: phone, email: newEmail, password: pass
                });

                // Atualiza a sess√£o no navegador do celular
                userEmail = newEmail; 
                localStorage.setItem('userEmail', newEmail);
                localStorage.setItem('userName', name);
                localStorage.setItem('loggedCustomer', JSON.stringify({ name, email: newEmail, phone }));

                alert("Dados atualizados com sucesso!");
                window.closeModals();
                loadProfile(); // Recarrega os dados na tela
                
            } catch (error) {
                console.error(error);
                alert("Erro ao salvar configura√ß√µes.");
            }
        };

        window.logoutCustomer = () => {
            if(confirm("Tem certeza que deseja sair da sua conta?")) {
                localStorage.removeItem('loggedCustomer');
                localStorage.setItem('isLogged', 'false');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userName');
                window.location.href = "index.html";
            }
        };

        window.onload = loadProfile;
    </script>
</body>
</html>
